name: Sync with Upstream

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹æ£€æŸ¥ï¼ˆUTC 0:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/escapeWu/perplexity-ai.git || true
          git fetch upstream

      - name: Check for upstream changes
        id: check
        run: |
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/main --count)
          echo "upstream_commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
          if [ "$UPSTREAM_COMMITS" -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Found $UPSTREAM_COMMITS new commits from upstream"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date with upstream"
          fi

      - name: Try to merge upstream (fast-forward or clean merge)
        id: merge
        if: steps.check.outputs.has_updates == 'true'
        run: |
          # å°è¯•åˆå¹¶
          if git merge upstream/main --no-edit; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Successfully merged upstream changes"
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Merge conflicts detected"
            git merge --abort
          fi

      - name: Push merged changes
        if: steps.check.outputs.has_updates == 'true' && steps.merge.outputs.merge_success == 'true'
        run: |
          git push origin main
          echo "ğŸš€ Pushed merged changes to origin/main"

      - name: Create Pull Request on conflict
        if: steps.check.outputs.has_updates == 'true' && steps.merge.outputs.merge_success == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "sync: merge upstream changes (manual resolution needed)"
          branch: sync-upstream-${{ github.run_number }}
          delete-branch: true
          title: "âš ï¸ Sync Upstream: Manual merge required"
          body: |
            ## ä¸Šæ¸¸æ›´æ–°éœ€è¦æ‰‹åŠ¨åˆå¹¶

            è‡ªåŠ¨åŒæ­¥æ£€æµ‹åˆ°ä¸Šæ¸¸ [escapeWu/perplexity-ai](https://github.com/escapeWu/perplexity-ai) æœ‰æ›´æ–°ï¼Œä½†å­˜åœ¨åˆå¹¶å†²çªã€‚

            ### éœ€è¦ä½ åšçš„ï¼š
            1. åœ¨æœ¬åœ°æ‹‰å–æ­¤åˆ†æ”¯
            2. æ‰‹åŠ¨è§£å†³å†²çª
            3. åˆå¹¶åˆ° main åˆ†æ”¯

            ### æœ¬åœ°æ“ä½œå‘½ä»¤ï¼š
            ```bash
            git fetch origin
            git checkout sync-upstream-${{ github.run_number }}
            git fetch upstream
            git merge upstream/main
            # è§£å†³å†²çªå
            git add .
            git commit -m "resolve merge conflicts with upstream"
            git push
            ```

            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          labels: |
            sync-upstream
            needs-manual-merge
