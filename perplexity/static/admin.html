<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perplexity Token Manager // POSTMODERN</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Work+Sans:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['"Space Mono"', 'monospace'],
                        sans: ['"Work Sans"', 'sans-serif'],
                    },
                    colors: {
                        'void': '#050505',
                        'concrete': '#1a1a1a',
                        'acid': '#ccff00',
                        'neon-pink': '#ff00ff',
                        'neon-blue': '#00ffff',
                        'danger': '#ff3333',
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #333333',
                        'hard-hover': '2px 2px 0px 0px #555555',
                        'hard-acid': '4px 4px 0px 0px #ccff00',
                        'hard-pink': '4px 4px 0px 0px #ff00ff',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .brutalist-card {
            background: #121212;
            border: 2px solid #333;
            box-shadow: 6px 6px 0px 0px #333;
            transition: all 0.2s ease;
        }
        .brutalist-card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 8px 8px 0px 0px #ccff00;
            border-color: #ccff00;
        }
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        .glitch-hover:hover {
            animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
        }
    </style>
</head>
<body class="min-h-screen text-gray-200 font-sans p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const API_BASE = window.location.origin;

        // --- Components ---

        const BrutalistCard = ({ number, label, value, colorClass }) => (
            <div className="brutalist-card p-6 relative group overflow-hidden">
                <div className={`absolute top-0 right-0 p-2 opacity-20 font-black text-6xl text-gray-700 pointer-events-none group-hover:${colorClass} transition-colors`}>
                    {number}
                </div>
                <div className="text-xs font-mono uppercase tracking-widest text-gray-500 mb-2">{label}</div>
                <div className={`text-4xl md:text-5xl font-black text-white group-hover:${colorClass} transition-colors truncate`}>
                    {value}
                </div>
            </div>
        );

        const Modal = ({ isOpen, title, children, onClose, onConfirm, confirmText = "Confirm", confirmColor = "bg-acid", borderColor = "border-acid" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex justify-center items-center backdrop-blur-sm">
                    <div className={`bg-black border-2 ${borderColor} w-full max-w-lg mx-4 p-8 shadow-[10px_10px_0px_0px_currentColor] relative text-${borderColor.replace('border-', '')}`}>
                        <div className={`absolute -top-3 -left-3 ${confirmColor} text-black px-2 py-1 font-mono text-xs font-bold transform -rotate-3`}>
                            SYSTEM_MSG
                        </div>
                        <h3 className="text-3xl font-black uppercase mb-8 text-white">{title}</h3>
                        <div className="text-gray-200">
                            {children}
                        </div>
                        <div className="flex justify-end gap-4 mt-10">
                            <button onClick={onClose} className="px-6 py-3 font-mono text-sm border border-gray-600 hover:bg-gray-800 transition-colors text-gray-400">
                                CANCEL
                            </button>
                            <button onClick={onConfirm} className={`px-6 py-3 ${confirmColor} text-black font-bold font-mono text-sm hover:bg-white transition-colors shadow-hard hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px]`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = type === 'success' ? 'bg-acid text-black' : 'bg-danger text-white';

            return (
                <div className={`fixed bottom-5 right-5 ${bgColor} px-6 py-4 font-mono text-sm font-bold shadow-hard z-50 border-2 border-black uppercase animate-bounce`}>
                    {`>> ${message}`}
                </div>
            );
        };

        // Auth Bar Component
        const AuthBar = ({ adminToken, setAdminToken, isAuthenticated, onLogout }) => {
            const [inputToken, setInputToken] = useState('');

            const handleAuth = () => {
                if (inputToken.trim()) {
                    setAdminToken(inputToken.trim());
                    localStorage.setItem('pplx_admin_token', inputToken.trim());
                    setInputToken('');
                }
            };

            const handleLogout = () => {
                setAdminToken('');
                localStorage.removeItem('pplx_admin_token');
                onLogout();
            };

            return (
                <div className="mb-8 p-4 border-2 border-gray-700 bg-gray-900/50">
                    <div className="flex flex-col md:flex-row items-start md:items-center gap-4">
                        <div className="flex items-center gap-2">
                            <span className={`w-3 h-3 rounded-full ${isAuthenticated ? 'bg-green-500 animate-pulse' : 'bg-gray-600'}`}></span>
                            <span className="font-mono text-xs uppercase tracking-widest text-gray-500">
                                {isAuthenticated ? 'AUTHENTICATED' : 'GUEST_MODE'}
                            </span>
                        </div>

                        {!isAuthenticated ? (
                            <div className="flex gap-2 flex-1 w-full md:w-auto">
                                <input
                                    type="password"
                                    placeholder="ADMIN_TOKEN..."
                                    value={inputToken}
                                    onChange={e => setInputToken(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && handleAuth()}
                                    className="flex-1 bg-gray-800 border border-gray-700 px-4 py-2 text-white font-mono text-sm focus:outline-none focus:border-acid transition-colors placeholder-gray-600"
                                />
                                <button
                                    onClick={handleAuth}
                                    className="px-4 py-2 bg-neon-pink text-black font-bold font-mono text-sm uppercase hover:bg-white transition-colors shadow-hard-pink hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px]"
                                >
                                    AUTH
                                </button>
                            </div>
                        ) : (
                            <div className="flex gap-2 items-center">
                                <span className="font-mono text-xs text-gray-400">TOKEN: ****{adminToken.slice(-4)}</span>
                                <button
                                    onClick={handleLogout}
                                    className="px-3 py-1 border border-gray-600 font-mono text-xs text-gray-400 hover:bg-gray-800 transition-colors"
                                >
                                    LOGOUT
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState({ total: 0, available: 0, mode: '-', clients: [] });
            const [isLoading, setIsLoading] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [toasts, setToasts] = useState([]);

            // Auth state
            const [adminToken, setAdminToken] = useState(() => localStorage.getItem('pplx_admin_token') || '');
            const [isAuthenticated, setIsAuthenticated] = useState(false);

            // Modals state
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [confirmAction, setConfirmAction] = useState(null);
            const [confirmMessage, setConfirmMessage] = useState("");

            // Form state
            const [addForm, setAddForm] = useState({ id: '', csrf: '', session: '' });

            // Heartbeat state
            const [hbConfig, setHbConfig] = useState(null);
            const [isGlobalTesting, setIsGlobalTesting] = useState(false);
            const [testingIds, setTestingIds] = useState(new Set());
            const [isHbConfigOpen, setIsHbConfigOpen] = useState(false);
            const [hbConfigForm, setHbConfigForm] = useState({
                enable: false,
                question: '',
                interval: 6,
                tg_bot_token: null,
                tg_chat_id: null
            });

            const addToast = useCallback((msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
            }, []);

            const removeToast = useCallback((id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            }, []);

            const refreshData = useCallback(async () => {
                setIsLoading(true);
                try {
                    const resp = await fetch(`${API_BASE}/pool/status`);
                    const jsonData = await resp.json();
                    setData(jsonData);
                    setLastSync(new Date().toLocaleTimeString('en-US', { hour12: false }));

                    // Also fetch heartbeat config
                    const hbResp = await fetch(`${API_BASE}/heartbeat/config`);
                    const hbJson = await hbResp.json();
                    if (hbJson.status === 'ok') {
                        setHbConfig(hbJson.config);
                    }
                } catch (e) {
                    addToast("CONNECTION_LOST", "error");
                } finally {
                    setIsLoading(false);
                }
            }, [addToast]);

            useEffect(() => {
                refreshData();
                const interval = setInterval(refreshData, 30000);
                return () => clearInterval(interval);
            }, [refreshData]);

            // Check auth status when token changes
            useEffect(() => {
                if (adminToken) {
                    // Verify token by making a simple call
                    setIsAuthenticated(true);
                } else {
                    setIsAuthenticated(false);
                }
            }, [adminToken]);

            // Sync hbConfigForm when hbConfig changes
            useEffect(() => {
                if (hbConfig) {
                    setHbConfigForm({
                        enable: hbConfig.enable || false,
                        question: hbConfig.question || '',
                        interval: hbConfig.interval || 6,
                        tg_bot_token: hbConfig.tg_bot_token || null,
                        tg_chat_id: hbConfig.tg_chat_id || null
                    });
                }
            }, [hbConfig]);

            const apiCall = useCallback(async (action, params = {}) => {
                try {
                    const headers = { 'Content-Type': 'application/json' };
                    if (adminToken) {
                        headers['X-Admin-Token'] = adminToken;
                    }

                    const url = action.startsWith('heartbeat') ? `${API_BASE}/${action}` : `${API_BASE}/pool/${action}`;

                    const resp = await fetch(url, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(params)
                    });
                    const result = await resp.json();

                    // Handle auth errors
                    if (resp.status === 401 || resp.status === 403) {
                        if (resp.status === 401) {
                            setIsAuthenticated(false);
                        }
                        return { status: 'error', message: result.message || 'Authentication failed' };
                    }

                    return result;
                } catch (e) {
                    return { status: 'error', message: e.message };
                }
            }, [adminToken]);

            const handleHeartbeatAction = async (action, params = {}) => {
                 if (!isAuthenticated) {
                    addToast('AUTH_REQUIRED', 'error');
                    return;
                }

                // Set testing state
                if (action === 'test') {
                    if (params.id) {
                        setTestingIds(prev => {
                            const next = new Set(prev);
                            next.add(params.id);
                            return next;
                        });
                    } else {
                        setIsGlobalTesting(true);
                    }
                }

                try {
                    const resp = await apiCall(`heartbeat/${action}`, params);
                    if (resp.status === 'ok') {
                        addToast(`HEARTBEAT_${action.toUpperCase()}_OK`);
                        refreshData();
                    } else {
                        addToast(resp.message, 'error');
                    }
                } finally {
                    // Clear testing state
                    if (action === 'test') {
                        if (params.id) {
                            setTestingIds(prev => {
                                const next = new Set(prev);
                                next.delete(params.id);
                                return next;
                            });
                        } else {
                            setIsGlobalTesting(false);
                        }
                    }
                }
            };

            const handleSaveHbConfig = async () => {
                if (!isAuthenticated) {
                    addToast('AUTH_REQUIRED', 'error');
                    return;
                }

                try {
                    const headers = { 'Content-Type': 'application/json' };
                    if (adminToken) {
                        headers['X-Admin-Token'] = adminToken;
                    }

                    const resp = await fetch(`${API_BASE}/heartbeat/config`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(hbConfigForm)
                    });
                    const result = await resp.json();

                    if (result.status === 'ok') {
                        addToast('CONFIG_SAVED');
                        setHbConfig(result.config);
                        setIsHbConfigOpen(false);
                    } else {
                        addToast(result.message || 'SAVE_FAILED', 'error');
                    }
                } catch (e) {
                    addToast('SAVE_FAILED', 'error');
                }
            };

            const handleAddToken = async () => {
                if (!isAuthenticated) {
                    addToast('AUTH_REQUIRED', 'error');
                    return;
                }
                if (!addForm.id || !addForm.csrf || !addForm.session) {
                    addToast('MISSING_FIELDS', 'error');
                    return;
                }
                const resp = await apiCall('add', {
                    id: addForm.id,
                    csrf_token: addForm.csrf,
                    session_token: addForm.session
                });

                if (resp.status === 'ok') {
                    addToast('TOKEN_INJECTED');
                    setIsAddModalOpen(false);
                    setAddForm({ id: '', csrf: '', session: '' });
                    refreshData();
                } else {
                    addToast(resp.message, 'error');
                }
            };

            const handleClientAction = useCallback(async (action, id) => {
                if (!isAuthenticated) {
                    addToast('AUTH_REQUIRED', 'error');
                    return;
                }

                const resp = await apiCall(action, { id });
                const actionMap = {
                    enable: 'ONLINE',
                    disable: 'OFFLINE',
                    reset: 'RESET',
                    remove: 'DELETED'
                };

                if (resp.status === 'ok') {
                    addToast(action === 'remove' ? 'TOKEN_DELETED' : `CLIENT_${id}_${actionMap[action]}`);
                    refreshData();
                } else {
                    addToast(resp.message, 'error');
                }
            }, [isAuthenticated, apiCall, addToast, refreshData]);

            const confirmRemove = (id) => {
                if (!isAuthenticated) {
                    addToast('AUTH_REQUIRED', 'error');
                    return;
                }
                setConfirmMessage(`Are you sure you want to permanently delete token "${id}"? This action is irreversible.`);
                setConfirmAction(() => () => handleClientAction('remove', id));
                setIsConfirmModalOpen(true);
            };

            const executeConfirm = async () => {
                if (confirmAction) await confirmAction();
                setIsConfirmModalOpen(false);
            };

            const getWeightColor = (weight) => {
                if (weight >= 70) return 'bg-acid';
                if (weight >= 40) return 'bg-yellow-500';
                return 'bg-danger';
            };

            const maskIdentifier = (id) => {
                if (!id || id.length <= 6) return id;
                const start = id.substring(0, 3);
                const end = id.substring(id.length - 3);
                return `${start}***${end}`;
            };

            const handleLogout = () => {
                addToast('LOGGED_OUT');
            };

            const enabledCount = useMemo(() => (data.clients || []).filter(c => c.enabled).length, [data.clients]);

            const getHeartbeatStatus = () => {
                if (!hbConfig) return { label: 'UNKNOWN', color: 'text-gray-500' };
                if (!hbConfig.enable) return { label: 'DISABLED', color: 'text-gray-500' };
                return { label: 'ACTIVE', color: 'text-green-500' };
            };
            const hbStatus = getHeartbeatStatus();

            return (
                <div className="max-w-7xl mx-auto">
                    {/* Header */}
                    <header className="mb-8 border-b-4 border-white pb-6">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                            <div>
                                <h1 className="text-5xl md:text-7xl font-black uppercase tracking-tighter leading-none text-white mix-blend-difference">
                                    Perplexity<br/>
                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-acid via-neon-pink to-neon-blue">Token Pool</span>
                                </h1>
                                <p className="font-mono text-gray-400 mt-2 bg-gray-900 inline-block px-2">/// MANAGER_V1.1_REACT</p>
                            </div>
                            <div className="font-mono text-xs md:text-sm text-right">
                                <div className="text-acid">{lastSync ? `LAST_SYNC: ${lastSync}` : 'SYNCING...'}</div>
                                <div className="text-gray-500">SYSTEM_STATUS: ONLINE</div>
                            </div>
                        </div>
                    </header>

                    {/* Auth Bar */}
                    <AuthBar
                        adminToken={adminToken}
                        setAdminToken={setAdminToken}
                        isAuthenticated={isAuthenticated}
                        onLogout={handleLogout}
                    />

                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
                        <BrutalistCard number="01" label="Total Clients" value={data.total || 0} colorClass="text-acid" />
                        <BrutalistCard number="02" label="Available" value={data.available || 0} colorClass="text-neon-blue" />
                        <BrutalistCard number="03" label="Enabled" value={enabledCount} colorClass="text-neon-pink" />
                        <BrutalistCard number="04" label="Heartbeat" value={hbStatus.label} colorClass={hbStatus.color} />
                    </div>

                    {/* Heartbeat Controls (Only if Auth) */}
                    {isAuthenticated && hbConfig && (
                        <div className="mb-8 p-4 border border-gray-700 bg-gray-900/30">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <h3 className="font-bold text-white uppercase tracking-wider">♥ Heartbeat Control</h3>
                                    <div className="text-xs font-mono text-gray-500">INTERVAL: {hbConfig.interval}H</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => setIsHbConfigOpen(!isHbConfigOpen)}
                                        className="px-3 py-1 bg-gray-800 border border-gray-600 hover:bg-white hover:text-black font-mono text-xs uppercase transition-colors"
                                    >
                                        {isHbConfigOpen ? 'Hide Config' : 'Config'}
                                    </button>
                                    {hbConfig.enable ? (
                                        <button
                                            onClick={() => handleHeartbeatAction('stop')}
                                            className="px-3 py-1 border border-red-500 text-red-500 hover:bg-red-500 hover:text-white font-mono text-xs uppercase transition-colors"
                                        >
                                            Stop Task
                                        </button>
                                    ) : (
                                        <button
                                            onClick={() => handleHeartbeatAction('start')}
                                            className="px-3 py-1 border border-green-500 text-green-500 hover:bg-green-500 hover:text-white font-mono text-xs uppercase transition-colors"
                                        >
                                            Start Task
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Config Panel */}
                            {isHbConfigOpen && (
                                <div className="border-t border-gray-700 pt-4 mt-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block font-mono text-xs text-gray-500 mb-1 uppercase">Enable</label>
                                            <select
                                                value={hbConfigForm.enable ? 'true' : 'false'}
                                                onChange={e => setHbConfigForm({...hbConfigForm, enable: e.target.value === 'true'})}
                                                className="w-full bg-gray-800 border border-gray-700 px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-acid"
                                            >
                                                <option value="true">Enabled</option>
                                                <option value="false">Disabled</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block font-mono text-xs text-gray-500 mb-1 uppercase">Interval (Hours)</label>
                                            <input
                                                type="number"
                                                min="1"
                                                max="24"
                                                value={hbConfigForm.interval}
                                                onChange={e => setHbConfigForm({...hbConfigForm, interval: parseInt(e.target.value) || 6})}
                                                className="w-full bg-gray-800 border border-gray-700 px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-acid"
                                            />
                                        </div>
                                        <div>
                                            <label className="block font-mono text-xs text-gray-500 mb-1 uppercase">Test Question</label>
                                            <input
                                                type="text"
                                                value={hbConfigForm.question}
                                                onChange={e => setHbConfigForm({...hbConfigForm, question: e.target.value})}
                                                className="w-full bg-gray-800 border border-gray-700 px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-acid"
                                            />
                                        </div>
                                        <div>
                                            <label className="block font-mono text-xs text-gray-500 mb-1 uppercase">Telegram Bot Token</label>
                                            <input
                                                type="password"
                                                value={hbConfigForm.tg_bot_token || ''}
                                                onChange={e => setHbConfigForm({...hbConfigForm, tg_bot_token: e.target.value || null})}
                                                placeholder="Optional..."
                                                className="w-full bg-gray-800 border border-gray-700 px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-acid placeholder-gray-600"
                                            />
                                        </div>
                                        <div>
                                            <label className="block font-mono text-xs text-gray-500 mb-1 uppercase">Telegram Chat ID</label>
                                            <input
                                                type="text"
                                                value={hbConfigForm.tg_chat_id || ''}
                                                onChange={e => setHbConfigForm({...hbConfigForm, tg_chat_id: e.target.value || null})}
                                                placeholder="Optional..."
                                                className="w-full bg-gray-800 border border-gray-700 px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-acid placeholder-gray-600"
                                            />
                                        </div>
                                        <div className="flex items-end">
                                            <button
                                                onClick={handleSaveHbConfig}
                                                className="px-4 py-2 bg-acid text-black font-bold font-mono text-sm uppercase hover:bg-white transition-colors shadow-hard-acid hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px]"
                                            >
                                                Save Config
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Main Panel */}
                    <div className="border-2 border-white bg-black p-1 shadow-[8px_8px_0px_0px_rgba(255,255,255,0.2)]">
                        <div className="bg-gray-900 border border-gray-800 p-4 md:p-6">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 border-b border-gray-800 pb-6">
                                <h2 className="text-2xl font-bold uppercase tracking-tight flex items-center gap-3">
                                    <span className="w-3 h-3 bg-acid block animate-pulse"></span>
                                    Active Tokens
                                </h2>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => handleHeartbeatAction('test')}
                                        className={`px-4 py-2 bg-gray-800 border border-gray-600 font-mono text-sm uppercase flex items-center gap-2 group shadow-hard hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all ${!isGlobalTesting && testingIds.size === 0 ? 'hover:bg-white hover:text-black hover:border-white' : 'opacity-50 cursor-not-allowed'}`}
                                        disabled={isGlobalTesting || testingIds.size > 0}
                                    >
                                        <span className={`transition-transform duration-500 ${isGlobalTesting ? 'animate-spin' : ''}`}>♥</span> TEST ALL
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (!isAuthenticated) {
                                                addToast('AUTH_REQUIRED', 'error');
                                                return;
                                            }
                                            setIsAddModalOpen(true);
                                        }}
                                        className={`px-4 py-2 font-bold border transition-all font-mono text-sm uppercase shadow-hard-acid hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] ${
                                            isAuthenticated
                                                ? 'bg-acid text-black border-acid hover:bg-transparent hover:text-acid'
                                                : 'bg-gray-700 text-gray-500 border-gray-600 cursor-not-allowed'
                                        }`}
                                    >
                                        + NEW TOKEN
                                    </button>
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                {!data.clients || data.clients.length === 0 ? (
                                    <div className="text-center py-20 font-mono text-gray-500 border-2 border-dashed border-gray-800">NO_DATA_FOUND // INJECT_NEW_TOKEN</div>
                                ) : (
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="border-b-2 border-gray-700">
                                                <th className="p-4 font-mono text-xs text-gray-500 uppercase tracking-widest">Identifier</th>
                                                <th className="p-4 font-mono text-xs text-gray-500 uppercase tracking-widest">State</th>
                                                <th className="p-4 font-mono text-xs text-gray-500 uppercase tracking-widest">Dynamic Weight</th>
                                                <th className="p-4 font-mono text-xs text-gray-500 uppercase tracking-widest">Reqs</th>
                                                <th className="p-4 font-mono text-xs text-gray-500 uppercase tracking-widest">Last Check</th>
                                                <th className="p-4 font-mono text-xs text-gray-500 uppercase tracking-widest text-right">Controls</th>
                                            </tr>
                                        </thead>
                                        <tbody className="font-mono text-sm">
                                            {data.clients.map(c => (
                                                <tr key={c.id} className="border-b border-gray-800 hover:bg-gray-900/50 transition-colors group">
                                                    <td className="p-4 font-bold text-white"><span className="text-neon-blue mr-2">&gt;</span>{maskIdentifier(c.id)}</td>
                                                    <td className="p-4">
                                                        {!c.enabled ? (
                                                            <span className="px-2 py-1 bg-gray-800 text-gray-500 text-xs border border-gray-700">DISABLED</span>
                                                        ) : !c.available ? (
                                                            <span className="px-2 py-1 bg-yellow-900/30 text-yellow-400 text-xs border border-yellow-900">BACKOFF</span>
                                                        ) : c.state === 'offline' ? (
                                                            <span className="px-2 py-1 bg-red-900/30 text-red-400 text-xs border border-red-900">OFFLINE</span>
                                                        ) : c.state === 'normal' ? (
                                                            <span className="px-2 py-1 bg-green-900/30 text-green-400 text-xs border border-green-900">HEALTHY</span>
                                                        ) : (
                                                            <span className="px-2 py-1 bg-blue-900/30 text-blue-400 text-xs border border-blue-900">READY</span>
                                                        )}
                                                    </td>
                                                    <td className="p-4">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-24 h-2 bg-gray-800 border border-gray-700 overflow-hidden">
                                                                <div className={`h-full ${getWeightColor(c.weight)} transition-all duration-500`} style={{width: `${c.weight}%`}}></div>
                                                            </div>
                                                            <span className="text-xs text-gray-500">{c.weight}%</span>
                                                        </div>
                                                    </td>
                                                    <td className="p-4 text-gray-400">
                                                        <div>{c.request_count || 0}</div>
                                                        <div className={(c.fail_count > 0 || c.pro_fail_count > 0) ? 'text-danger text-xs' : 'text-gray-600 text-xs'}>
                                                            E:{c.fail_count} / P:{c.pro_fail_count}
                                                        </div>
                                                    </td>
                                                    <td className="p-4 text-gray-500 text-xs">
                                                        {c.last_heartbeat_at ? new Date(c.last_heartbeat_at).toLocaleTimeString() : '-'}
                                                    </td>
                                                    <td className="p-4 text-right">
                                                        <div className={`flex justify-end gap-2 ${isAuthenticated ? '' : 'opacity-50'}`}>
                                                            {c.enabled ? (
                                                                <button
                                                                    className={`p-1 transition-colors ${isAuthenticated ? 'hover:text-yellow-500' : 'cursor-not-allowed'}`}
                                                                    onClick={() => handleClientAction('disable', c.id)}
                                                                    title="Disable"
                                                                    disabled={!isAuthenticated}
                                                                >[PAUSE]</button>
                                                            ) : (
                                                                <button
                                                                    className={`p-1 transition-colors ${isAuthenticated ? 'hover:text-green-500' : 'cursor-not-allowed'}`}
                                                                    onClick={() => handleClientAction('enable', c.id)}
                                                                    title="Enable"
                                                                    disabled={!isAuthenticated}
                                                                >[RESUME]</button>
                                                            )}
                                                            <button
                                                                className={`p-1 transition-colors ${isAuthenticated && !isGlobalTesting && !testingIds.has(c.id) ? 'hover:text-neon-blue' : 'cursor-not-allowed opacity-50'}`}
                                                                onClick={() => handleHeartbeatAction('test', {id: c.id})}
                                                                title="Test Heartbeat"
                                                                disabled={!isAuthenticated || isGlobalTesting || testingIds.has(c.id)}
                                                            >[TEST]</button>
                                                            <button
                                                                className={`p-1 transition-colors ${isAuthenticated ? 'hover:text-danger' : 'cursor-not-allowed'}`}
                                                                onClick={() => confirmRemove(c.id)}
                                                                title="Remove"
                                                                disabled={!isAuthenticated}
                                                            >[DEL]</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Add Modal */}
                    <Modal
                        isOpen={isAddModalOpen}
                        onClose={() => setIsAddModalOpen(false)}
                        onConfirm={handleAddToken}
                        title="Inject Token"
                        confirmText="CONFIRM UPLOAD"
                        confirmColor="bg-acid"
                        borderColor="border-acid"
                    >
                        <div className="space-y-6">
                            <div>
                                <label className="block font-mono text-xs text-acid mb-2 uppercase tracking-widest">Identifier</label>
                                <input type="text" placeholder="USER_ID_01" value={addForm.id}
                                    onChange={e => setAddForm({...addForm, id: e.target.value})}
                                    className="w-full bg-gray-900 border-b-2 border-gray-700 p-3 text-white font-mono focus:outline-none focus:border-acid focus:bg-gray-800 transition-colors placeholder-gray-700"/>
                            </div>
                            <div>
                                <label className="block font-mono text-xs text-acid mb-2 uppercase tracking-widest">CSRF Token</label>
                                <textarea rows="2" placeholder="ENCRYPTED_STRING..." value={addForm.csrf}
                                    onChange={e => setAddForm({...addForm, csrf: e.target.value})}
                                    className="w-full bg-gray-900 border-b-2 border-gray-700 p-3 text-white font-mono focus:outline-none focus:border-acid focus:bg-gray-800 transition-colors placeholder-gray-700 text-xs"></textarea>
                            </div>
                            <div>
                                <label className="block font-mono text-xs text-acid mb-2 uppercase tracking-widest">Session Token</label>
                                <textarea rows="3" placeholder="SESSION_KEY..." value={addForm.session}
                                    onChange={e => setAddForm({...addForm, session: e.target.value})}
                                    className="w-full bg-gray-900 border-b-2 border-gray-700 p-3 text-white font-mono focus:outline-none focus:border-acid focus:bg-gray-800 transition-colors placeholder-gray-700 text-xs"></textarea>
                            </div>
                        </div>
                    </Modal>

                    {/* Confirm Modal */}
                    <Modal
                        isOpen={isConfirmModalOpen}
                        onClose={() => setIsConfirmModalOpen(false)}
                        onConfirm={executeConfirm}
                        title="Warning"
                        confirmText="EXECUTE"
                        confirmColor="bg-danger"
                        borderColor="border-danger"
                    >
                        <p className="font-mono text-gray-300 mb-8 border-l-2 border-gray-700 pl-4">{confirmMessage}</p>
                    </Modal>

                    {/* Toasts */}
                    {toasts.map(t => (
                        <Toast key={t.id} message={t.msg} type={t.type} onClose={() => removeToast(t.id)} />
                    ))}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
